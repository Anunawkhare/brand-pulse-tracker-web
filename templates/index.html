<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrandPulse Tracker</title>
    <!-- Load Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Load Tailwind CSS for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="container mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8">BrandPulse Tracker</h1>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8" id="stats-container">
            <!-- Stats will be loaded here by JavaScript -->
        </div>

        <!-- Chart -->
        <div class="bg-white p-4 rounded shadow mb-8">
            <canvas id="sentimentChart"></canvas>
        </div>

        <!-- Mentions List -->
        <div class="bg-white p-4 rounded shadow">
            <h2 class="text-xl font-semibold mb-4">Recent Mentions</h2>
            <div id="mentions-container">
                <!-- Mentions will be loaded here by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Function to fetch data from the Flask backend
        async function fetchData() {
            try {
                // Fetch mentions and stats from the API
                const [mentionsResponse, statsResponse] = await Promise.all([
                    fetch('http://localhost:5000/api/mentions'),
                    fetch('http://localhost:5000/api/stats')
                ]);

                const mentions = await mentionsResponse.json();
                const stats = await statsResponse.json();

                // Update the UI with the new data
                updateStats(stats);
                updateChart(stats);
                updateMentionsList(mentions);
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Function to update the stats cards
        function updateStats(stats) {
            const statsContainer = document.getElementById('stats-container');
            statsContainer.innerHTML = `
                <div class="stat-card bg-blue-100 p-4 rounded">
                    <h3 class="font-bold">Total Mentions</h3>
                    <p class="text-2xl">${stats.total_mentions}</p>
                </div>
                <div class="stat-card bg-green-100 p-4 rounded">
                    <h3 class="font-bold">Positive</h3>
                    <p class="text-2xl">${stats.positive_mentions}</p>
                </div>
                <div class="stat-card bg-red-100 p-4 rounded">
                    <h3 class="font-bold">Negative</h3>
                    <p class="text-2xl">${stats.negative_mentions}</p>
                </div>
                <div class="stat-card bg-gray-100 p-4 rounded">
                    <h3 class="font-bold">Neutral</h3>
                    <p class="text-2xl">${stats.neutral_mentions}</p>
                </div>
            `;
        }

        // Function to update the chart
        let sentimentChart = null;
        function updateChart(stats) {
            const ctx = document.getElementById('sentimentChart').getContext('2d');
            
            // Destroy the previous chart if it exists
            if (sentimentChart) {
                sentimentChart.destroy();
            }

            sentimentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Positive', 'Negative', 'Neutral'],
                    datasets: [{
                        data: [stats.positive_mentions, stats.negative_mentions, stats.neutral_mentions],
                        backgroundColor: ['#10B981', '#EF4444', '#6B7280'],
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Mentions by Sentiment'
                        }
                    }
                }
            });
        }

        // Function to update the mentions list
        function updateMentionsList(mentions) {
            const container = document.getElementById('mentions-container');
            container.innerHTML = mentions.slice(0, 20).map(mention => `
                <div class="mention-item border-b py-3">
                    <div class="flex justify-between">
                        <span class="font-medium">${mention.source}</span>
                        <span class="sentiment-badge ${getSentimentColor(mention.sentiment)} px-2 py-1 rounded-full text-xs">
                            ${mention.sentiment}
                        </span>
                    </div>
                    <p class="my-2">${mention.text}</p>
                    <div class="flex justify-between text-sm text-gray-600">
                        <a href="${mention.url}" target="_blank" class="text-blue-500 hover:underline">View Source</a>
                        <span>${new Date(mention.timestamp).toLocaleString()}</span>
                    </div>
                </div>
            `).join('');
        }

        // Helper function to get color based on sentiment
        function getSentimentColor(sentiment) {
            switch(sentiment) {
                case 'positive': return 'bg-green-200 text-green-800';
                case 'negative': return 'bg-red-200 text-red-800';
                default: return 'bg-gray-200 text-gray-800';
            }
        }

        // Load data when the page loads and set up periodic refreshes
        document.addEventListener('DOMContentLoaded', function() {
            fetchData();
            // Refresh data every 30 seconds
            setInterval(fetchData, 30000);
        });
    </script>
</body>
</html>